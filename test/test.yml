---

- hosts: all
  become: 'yes'
  roles:
    - role: ansible-role-mysql
      mysql_databases:
        - name: 'test'
          path: /vagrant/storage/sample.sql
        - name: 'test1'
      mysql_users:
        - name: 'test'
          privs:
            - 'test.*:ALL'
          hosts:
            - localhost
        - name: 'test1'
          privs:
            - 'test1.*:ALL'
          hosts:
            - localhost
      mysql_config:
        mysqld:
          port: 3306
          socket: /var/run/mysqld/mysql.sock
        mysql:
          no_auto_rehash: ~
          max_allowed_packet: 16M
          prompt: '\u@\h [\d]> '
          default_character_set: utf8
        mysqldump:
          max_allowed_packet: 16M
        mysqld_safe:
          open_files_limit: 8192
          user: mysql
          log-error: <hostname>_error.log
  tasks:
    - name: Query to test db
      command: mysql -utest -ptest test -Ns -e "select * from customers"
      register: show_test_query

    - debug:
        var: show_test_query

    - name: Query to test1 db
      command: mysql -utest1 -ptest1 test -Ns -e "select * from customers"
      register: show_test1_query
      ignore_errors: 'True'

    - debug:
        var: show_test1_query

    - assert:
        that:
          - "'Atelier graphique' in show_test_query.stdout"
          - "'customers' not in show_test_query.stderr"
        msg: "User test1 have acces to db"
